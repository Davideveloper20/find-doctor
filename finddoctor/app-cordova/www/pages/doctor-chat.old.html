<template>
    <div class="page chat-page">
      <div class="navbar">
        <div class="navbar-inner sliding" style="top:0;">
          <div class="left rflex">
            <a href="#" class="link back" >
              <i class="f7-icons">chevron_left</i>
              <span class="ios-only">Back</span>
            </a>
          </div>
          <div class="title blue2 rflex zi-5" id="chatTitle">
            
          </div>
          <div class="right rflex">
            <img src="assets/imgs/icon.png" id="chatDoctorImg" alt="Find Doctor">
          </div>
        </div>
      </div>
    <div class="toolbar messagebar" @messagebar:attachmentdelete="deleteAttachment">
      <div class="toolbar-inner">
        <!-- <a class="link icon-only" @click="fromCamera">
          <i class="icon material-icons">camera_alt</i>
        </a> -->
        <div class="messagebar-area">
          <textarea class="resizable" placeholder="Message" id="message-bar-textarea"></textarea>
        </div>
        <a class="link icon-only demo-send-message-link" @click="sendMessage">
          <i class="icon material-icons">send</i>
        </a>
      </div>
    </div>
    <div class="page-content messages-content bg-transparent">
      <div class="messages bg-transparent">
        
      </div>
    </div>
  </div>
</template>
<script>
  return {
    data: function () {
      var currentUser = this.content.data.user
      return {
        usuario: currentUser,
        chat: this.content.data.chat,
        friend: this.content.data.friend
      };
    },
    methods: {
      sheetToggle: function () {
        var self = this;
        self.messagebar.sheetToggle();
      },
      deleteAttachment: function (e, index) {
        var self = this;
        var image = self.messagebar.attachments.splice(index, 1)[0];
        self.messagebar.renderAttachments();
        self.checkAttachments();
        // Uncheck in sheet
        var imageIndex = self.images.indexOf(image);
        self.$el.find('.messagebar-sheet .checkbox').eq(imageIndex).find('input').prop('checked', false);
      },
      handleAttachment: function (e) {
        var self = this;
        var $$ = self.$$;
        var index = $(e.target).parents('label.checkbox').index();
        var image = self.images[index];
        if (e.target.checked) {
          // Add to attachments
          self.messagebar.attachments.unshift(image)
        } else {
          // Remove from attachments
          self.messagebar.attachments.splice(self.messagebar.attachments.indexOf(image), 1);
        }
        self.messagebar.renderAttachments();
        self.checkAttachments();
        //rq
      },
      checkAttachments: function () {
        var self = this;
        if (self.messagebar.attachments.length > 0) {
          self.messagebar.attachmentsShow();
          self.messagebar.setPlaceholder('Add comment or Send');
        } else {
          self.messagebar.attachmentsHide();
          self.messagebar.setPlaceholder('Message');
        }
      },
      sendMessage: function () {
        var self = this;
        var date = new Date()
        var hora = date.getHours()+':'+date.getMinutes()
        var productId = this.$route.params.id;
        var ayudas = this.$route.params.ayudas;
        var random = Math.floor(Math.random() * 10000);
        var text = self.messagebar.getValue().replace(/\n/g, '<br>').trim();
        if(text!="")
        {
          var messagesToSend = [];
          self.messagebar.attachments.forEach(function (attachment) {
            var size = attachment.split('lorempixel.com/')[1].split('/');
            messagesToSend.push({
              image: '<img src="' + attachment + '" style="width: ' + (size[0]/2) + 'px; height: ' + (size[1]/2) + 'px">'
            });
          });
          if (text.trim().length) {
            messagesToSend.push({
              text: text,
              textFooter: hora+ ' <i class="material-icons" id="'+random+'">access_time</i>'
            });
          }
          // Reset attachments
          self.messagebar.attachments = [];
          self.checkAttachments();
          // Hide sheet
          self.messagebar.sheetHide();
          // Uncheck selected images in sheet
          self.messagebar.$sheetEl.find('input').prop('checked', false);
          // Clear area
          self.messagebar.clear();
          // Focus area
          if (text.length) self.messagebar.focus();
          // Send message
          self.messages.addMessages(messagesToSend);
          $('span[name="last-message-sent-'+ayudas+'"]').html(text)
          solstar.ajaxRequest("app/mensaje/"+productId+"/"+ayudas, "POST", function(data){
            $('#'+data.random).parents('.message').attr('id', 'msg'+data.id)
            $('#'+data.random).html('done')
            $('.messages').scrollTop($('.messages')[0].scrollHeight)
            //homeView.router.refreshPage()
          }, {text: text, random: random,hour:hora,type: 1}, false)
        }
      },
    },
    on: {
      pageBeforeIn: function(e , page)
      {
      },
      pageBeforeRemove: function (e, page) {
        var self = this;
        var subject = this.$route.params.ayudas;
        if (self.messagebar) self.messagebar.destroy();
        solstar.ajaxRequest("app/closeChat/"+subject, "GET", function(data){
          console.log(data)
        })
        clearInterval(refreshIntervalId);
      },
      pageAfterIn: function(e, page)
      {
        $('.messages').scrollTop($('.messages')[0].scrollHeight)
        $('.messages').find('.message-last').focus()
        $('textarea').on('focus', function(e) {
          e.preventDefault(); e.stopPropagation();
          setKeyboardPos(e.target.id) //the second 0 marks the Y scroll pos. Setting this to i.e. 100 will push the screen up by 100px. 
        });
        function setKeyboardPos(tarId) 
        {
          //programmatically: set scroll pos so keyboard aligns perfectly underneath textfield
          var elVerticalDistance = $("#"+tarId).offset()["top"];
          var keyboardHeight = 157;

          if(isNativeApp()) { keyboardHeight = 261; } //I choose to change the keyboard height for the sake of simplicity. Obviously, this value does not correnspond to the actual height of the keyboard but it does the trick
          var keyboardTextfieldPadding = 2;
          var heightOfView = document.height;
          var inputHeight = $("#"+tarId).outerHeight();

          var viewPortSpace = heightOfView-keyboardHeight-keyboardTextfieldPadding; //180
          var verticalNewSroll = (elVerticalDistance+inputHeight)-viewPortSpace;
          if(verticalNewSroll<0) { verticalNewSroll = 0; }
          ////
          //OK, all done lets go ahead with some actions
          //$("#footer").hide(); //hide footer so that the keyboard doesn't push it on top of textfield
          //$("#containingDiv").css("bottom","0px"); //remove bottom space for footer
          window.scrollTo(0,verticalNewSroll); // perform scroll!
        }
        function isNativeApp() {

          var app = (document.URL.indexOf('http://') === -1) && (document.URL.indexOf('https://') === -1);
          if (app) {
              return true; // PhoneGap native application
          } else {
              return false; // Web app / safari
          }
        }
      },
      pageInit: function (e, page) {
        var self = this;
        var app = self.$app;
        self.messagebar = app.messagebar.create({
          el: page.$el.find('.messagebar'),
          attachments: []
        });
        activarChat(this.$route.params.ayudas)
        self.messages = app.messages.create({
          el: page.$el.find('.messages'),
          firstMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!previousMessage || previousMessage.type !== message.type || previousMessage.name !== message.name) return true;
            return false;
          },
          lastMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
            return false;
          },
          tailMessageRule: function (message, previousMessage, nextMessage) {
            if (message.isTitle) return false;
            if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
            return false;
          }
        });
        window.onresize = function()
        {
          $('.messages').scrollTop($('.messages')[0].scrollHeight)
        }
      }
    }
  }
</script>
